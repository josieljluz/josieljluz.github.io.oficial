# ğŸ“› Nome do workflow que aparecerÃ¡ na interface do GitHub Actions
name: ğŸ§¹Limpar ExecuÃ§Ãµes de Workflow Antigas (12h)

# ğŸŸ¡ Gatilhos que disparam a execuÃ§Ã£o do workflow
on:
  # â° Disparo automÃ¡tico com base em agendamento (CRON)
  schedule:
    # Executa a cada 12 horas, sempre no minuto 1 (ex: 01:00 e 13:00 UTC)
    - cron: '1 */12 * * *'

  # ğŸ§‘â€ğŸ’» Permite execuÃ§Ã£o manual pela interface do GitHub (botÃ£o "Run workflow")
  workflow_dispatch:

# ğŸ§± DefiniÃ§Ã£o do job principal chamado "cleanup"
jobs:
  cleanup:
    # ğŸ–¥ï¸ Define que o job serÃ¡ executado em uma mÃ¡quina virtual Ubuntu
    runs-on: ubuntu-latest

    # ğŸ” Define as permissÃµes necessÃ¡rias para que o job possa deletar execuÃ§Ãµes
    permissions:
      actions: write  # Permite deletar execuÃ§Ãµes de workflows usando a API do GitHub

    # ğŸ“‹ Lista de passos que serÃ£o executados dentro do job
    steps:
      - name: ğŸ—‘ï¸ Deletar execuÃ§Ãµes de workflow antigas
        # ğŸŒ± Define variÃ¡veis de ambiente disponÃ­veis neste passo
        env:
          # Token de autenticaÃ§Ã£o automÃ¡tica fornecido pelo GitHub Actions
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        # â–¶ï¸ Comandos que serÃ£o executados no shell
        run: |
          # ğŸ” Mensagem inicial
          echo "ğŸ” Iniciando verificaÃ§Ã£o de execuÃ§Ãµes com mais de 12 horas..."

          # ğŸ•’ ObtÃ©m o timestamp atual em segundos (UTC)
          now=$(date -u +%s)

          # ğŸ“„ Define a quantidade mÃ¡xima de execuÃ§Ãµes retornadas por pÃ¡gina (100 Ã© o limite da API)
          per_page=100

          # ğŸ“„ ComeÃ§a da pÃ¡gina 1 (para paginaÃ§Ã£o dos resultados)
          page=1

          # ğŸ§® Contador de execuÃ§Ãµes deletadas
          deleted=0

          # ğŸ” LaÃ§o para percorrer todas as pÃ¡ginas atÃ© que nÃ£o haja mais execuÃ§Ãµes
          while true; do
            echo "ğŸ“„ Buscando pÃ¡gina $page de execuÃ§Ãµes..."

            # ğŸ”½ Chamada Ã  API para obter execuÃ§Ãµes da pÃ¡gina atual
            # O --jq filtra os campos 'id' e 'created_at' de cada execuÃ§Ã£o
            runs=$(gh api \
              -H "Accept: application/vnd.github.v3+json" \
              "/repos/${{ github.repository }}/actions/runs?per_page=$per_page&page=$page" \
              --jq '.workflow_runs[] | {id, created_at, status}')

            # âŒ Se a variÃ¡vel runs estiver vazia, nÃ£o hÃ¡ mais execuÃ§Ãµes nesta pÃ¡gina
            if [ -z "$runs" ]; then
              echo "âœ… Nenhuma execuÃ§Ã£o encontrada na pÃ¡gina $page. Fim da paginaÃ§Ã£o."
              break  # Encerra o laÃ§o
            fi

            # ğŸ” Itera sobre cada execuÃ§Ã£o retornada
            echo "$runs" | jq -c 'select(.created_at != null)' | while read -r run; do
              # ğŸ”¢ Extrai o ID da execuÃ§Ã£o
              id=$(echo "$run" | jq -r '.id')

              # ğŸ—“ï¸ Extrai a data de criaÃ§Ã£o (formato ISO 8601)
              created_at=$(echo "$run" | jq -r '.created_at')

              # ğŸ•’ Converte a data de criaÃ§Ã£o para timestamp Unix (em segundos)
              if date -u -d "$created_at" >/dev/null 2>&1; then
                # âœ… CompatÃ­vel com Linux (GNU)
                run_date=$(date -u -d "$created_at" +%s)
              elif date -u -j -f "%Y-%m-%dT%H:%M:%SZ" "$created_at" >/dev/null 2>&1; then
                # âœ… CompatÃ­vel com macOS (BSD)
                run_date=$(date -u -j -f "%Y-%m-%dT%H:%M:%SZ" "$created_at" +%s)
              else
                # âš ï¸ Se nÃ£o conseguir converter, exibe aviso e pula
                echo "âš ï¸ Data invÃ¡lida: $created_at"
                continue
              fi

              # ğŸ“ Calcula diferenÃ§a de tempo entre agora e a data da execuÃ§Ã£o (em horas)
              diff_hours=$(( (now - run_date) / 3600 ))

              # ğŸ§¹ Se a execuÃ§Ã£o tiver mais de 12 horas
              if [ "$diff_hours" -ge 12 ]; then
                echo "ğŸ—‘ï¸ Deletando execuÃ§Ã£o ID: $id (Criada hÃ¡ $diff_hours horas)"

                # ğŸ§¨ RequisiÃ§Ã£o DELETE para remover a execuÃ§Ã£o usando a API
                gh api \
                  --method DELETE \
                  -H "Accept: application/vnd.github.v3+json" \
                  "/repos/${{ github.repository }}/actions/runs/$id" \
                  >/dev/null 2>&1 && deleted=$((deleted + 1)) || echo "âš ï¸ Falha ao deletar execuÃ§Ã£o ID: $id"
              else
                # â³ Se tiver menos de 12h, apenas exibe log e mantÃ©m
                echo "âœ… ExecuÃ§Ã£o ID: $id tem apenas $diff_hours horas â€” serÃ¡ mantida."
              fi
            done

            # ğŸ” Incrementa o nÃºmero da pÃ¡gina para buscar a prÃ³xima
            page=$((page + 1))
          done

          # ğŸ§¾ Mensagem final com total de execuÃ§Ãµes removidas
          echo "ğŸ Processo concluÃ­do. Total de execuÃ§Ãµes deletadas: $deleted"